# docker compose v2+ â€“ no version key

x-default-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

x-default-restart: &default-restart
  restart: unless-stopped

networks:
  control-plane:
  range-plane:
  observability:

volumes:
  nats-data:
  minio-data:
  loki-data:

services:
  # ---------- Infra: NATS ----------
  nats:
    image: nats:2.10.8
    container_name: frostgate-foundry-nats-1
    # ENTRYPOINT is /nats-server, only pass flags here
    command:
      - -js
      - -m
      - "8222"
      - -sd
      - /var/lib/nats/jetstream
    ports:
      - "4222:4222"   # client
      - "8222:8222"   # monitoring
    volumes:
      - nats-data:/var/lib/nats/jetstream
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8222/varz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - control-plane
    <<: [*default-logging, *default-restart]

  # ---------- Infra: MinIO ----------
  minio:
    image: minio/minio:latest   # pin in prod
    container_name: frostgate-foundry-minio-1
    environment:
      MINIO_ROOT_USER: admin          # TODO: change
      MINIO_ROOT_PASSWORD: adminadmin # TODO: change
    command: ["server", "/data", "--console-address", ":9001"]
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9000/minio/health/live >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    networks:
      - control-plane
    <<: [*default-logging, *default-restart]

  # ---------- Infra: Loki ----------
  loki:
    image: grafana/loki:2.9.0
    container_name: frostgate-foundry-loki-1
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - loki-data:/loki
    ports:
      - "3100:3100"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3100/ready >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - observability
    <<: [*default-logging, *default-restart]

  # ---------- Infra: OPA ----------
  opa:
    image: openpolicyagent/opa:latest
    container_name: frostgate-foundry-opa-1
    command:
      - run
      - --server
      - --addr=0.0.0.0:8181
      - --diagnostic-addr=0.0.0.0:8282
      - --ignore=.*\.rego\.disabled
      - /policies
    volumes:
      - ./opa:/policies:ro    # adjust if your policies live elsewhere
    ports:
      - "8181:8181"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8181/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 20s
    networks:
      - control-plane
    <<: [*default-logging, *default-restart]

  # ---------- App: Orchestrator ----------
  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    image: frostgate-foundry-orchestrator
    container_name: frostgate-foundry-orchestrator-1
    depends_on:
      - nats
      - minio
      - opa
    # env_file: services/orchestrator/.env.ci  # uncomment + create file when ready
    networks:
      - control-plane
      - range-plane
    <<: [*default-logging, *default-restart]

  # ---------- App: Ingestors ----------
  ingestors:
    build:
      context: .
      dockerfile: services/ingestors/Dockerfile
    image: frostgate-foundry-ingestors
    container_name: frostgate-foundry-ingestors-1
    depends_on:
      - nats
      - minio
    # env_file: services/ingestors/.env
    networks:
      - control-plane
      - range-plane
    <<: [*default-logging, *default-restart]

  # ---------- App: Spawn Service ----------
  spawn_service:
    build:
      context: .
      dockerfile: services/spawn_service/Dockerfile
    image: frostgate-foundry-spawn-service
    container_name: frostgate-foundry-spawn_service-1
    depends_on:
      - nats
      - orchestrator
    # env_file: services/spawn_service/.env
    networks:
      - control-plane
      - range-plane
    <<: [*default-logging, *default-restart]
