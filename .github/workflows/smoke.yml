name: sentinelcore-smoke
on:
  pull_request:
    paths:
      - 'backend/sentinelcore/**'
      - 'infra/**'
      - 'scripts/**'
jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Build and start
        run: |
          docker compose -f infra/docker-compose.yml up -d --build sentinelcore
      - name: Wait for health
        run: |
          for i in {1..60}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || true)
            if [ "$code" = "200" ]; then exit 0; fi
            sleep 2
          done
          echo "healthcheck failed"; docker ps; docker logs $(docker ps -q --filter name=sentinelcore) || true; exit 1
      - name: Install test deps
        run: pip install httpx pytest
      - name: Run API contract tests
        env:
          BASE_URL: http://localhost:8000
        run: pytest -q backend/sentinelcore/tests
