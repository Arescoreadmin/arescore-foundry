name: smoke
on:
  pull_request:
    branches: [ main ]

jobs:
  precommit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Guard: no duplicate 'allow {' heads in foundry.training outside foundry.rego
      - name: Policy guard
        run: |
          chmod +x scripts/ci_guard_rego_heads.sh || true
          if [[ -x scripts/ci_guard_rego_heads.sh ]]; then
            scripts/ci_guard_rego_heads.sh
          else
            echo "WARN: scripts/ci_guard_rego_heads.sh not found; skipping"
          fi

      # OPA unit tests with official image (no compose, no daemon perms needed)
      - name: OPA tests
        run: |
          docker run --rm -v "$PWD/policies:/policies:ro" openpolicyagent/opa:0.67.0 test -v /policies

      # Compose lint only (donâ€™t up services on CI)
      - name: Compose config lint
        run: |
          docker compose version || sudo apt-get update && sudo apt-get install -y docker-compose-plugin
          docker compose -f infra/docker-compose.yml -f infra/compose.opa.yml config >/dev/null
