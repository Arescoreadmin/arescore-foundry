# .github/workflows/smoke.yml
name: smoke
on:
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      # âœ… OPA policy unit tests (static, no containers)
      - name: Policy tests (OPA v1.10)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/policies:/policies:ro" \
            openpolicyagent/opa:1.10.0 \
            test /policies -v

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build orchestrator (no push)
        run: docker build -t local/orchestrator:test ./services/orchestrator

      - name: Compose up (base + override)
        run: |
          mkdir -p /opt/arescore-foundry
          rsync -a ./ /opt/arescore-foundry/
          docker compose \
            -f /opt/arescore-foundry/compose.yml \
            -f /opt/arescore-foundry/compose.override.yml up -d

      - name: Wait for health
        run: |
          t=60; while ! curl -fsS http://127.0.0.1:8181/ >/dev/null; do [ $((t-=1)) -le 0 ] && exit 1; sleep 1; done
          t=60; while ! curl -fsS http://127.0.0.1:8080/health >/dev/null; do [ $((t-=1)) -le 0 ] && exit 1; sleep 1; done

      - name: Policy -> OPA
        run: |
          printf '%s' '{"input":{"metadata":{"labels":["class:netplus"]},"limits":{"attacker_max_exploits":0},"network":{"egress":"deny"}}}' \
          | curl -fsS http://127.0.0.1:8181/v1/data/foundry/training/allow -H 'content-type: application/json' -d @- \
          | jq -e '.result==true' >/dev/null

      - name: Orchestrator -> OPA
        run: |
          printf '%s' '{"metadata":{"labels":["class:netplus"]},"limits":{"attacker_max_exploits":0},"network":{"egress":"deny"}}' \
          | curl -fsS http://127.0.0.1:8080/scenarios -H 'content-type: application/json' -d @- \
          | jq -e '.allowed==true' >/dev/null

      - name: Tear down
        if: always()
        run: docker compose down -v || true
