name: smoke-tests

on:
  pull_request:
    paths:
      - "compose.yml"
      - "compose.*.yml"
      - "services/**"
      - "scripts/smoke_overlay.sh"
  workflow_dispatch: {}

jobs:
  overlay:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Compose config sanity
        run: docker compose -f compose.yml -f compose.federated.yml config --quiet
      - name: Bring up
        run: docker compose --profile control-plane --profile range-plane -f compose.yml -f compose.federated.yml up -d --build
      - name: Smoke overlay
        run: bash scripts/smoke_overlay.sh
      - name: Teardown
        if: always()
        run: docker compose -f compose.yml -f compose.federated.yml down -v
