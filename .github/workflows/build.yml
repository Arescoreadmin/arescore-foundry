name: build

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout
      # Shallow is fine for PR build
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Preflight orchestrator without importing FastAPI/Pydantic.
      # We parse the file with AST and assert an assignment to name "app".
      - name: Preflight orchestrator sources
        shell: bash
        run: |
          set -euo pipefail
          test -s services/orchestrator/app/main.py
          python3 - <<'PY'
          import ast, sys, pathlib
          p = pathlib.Path("services/orchestrator/app/main.py")
          src = p.read_text(encoding="utf-8")
          try:
              tree = ast.parse(src, filename=str(p))
          except SyntaxError as e:
              print(f"Syntax error in {p}: {e}", file=sys.stderr)
              sys.exit(1)
          has_app_assign = any(isinstance(n, ast.Assign) and any(
              isinstance(t, ast.Name) and t.id == "app" for t in n.targets
          ) for n in ast.walk(tree))
          if not has_app_assign:
              print("Missing FastAPI app assignment to variable 'app'", file=sys.stderr)
              sys.exit(1)
          print("orchestrator main.py AST check OK")
          PY

      # OPA policy gate. Fails fast on parse/type errors; runs tests if present.
      - name: OPA policy check
        shell: bash
        run: |
          set -euo pipefail
          if [ -d policies ]; then
            docker run --rm -v "$PWD/policies:/policies:ro" openpolicyagent/opa:1.10.0 check /policies
            docker run --rm -v "$PWD/policies:/policies:ro" openpolicyagent/opa:1.10.0 test /policies
          else
            echo "No policies/ directory; skipping OPA gate."
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build orchestrator image (no push on PRs)
      - name: Build orchestrator image
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          docker build --progress=plain \
            -t local/orchestrator:test \
            ./services/orchestrator
