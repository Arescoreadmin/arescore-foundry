name: CI

on:
  push:
    branches:
      - main
      - feat/**
      - chore/**
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  policy-check:
    name: OPA policy checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run OPA unit tests (test -v)
        run: |
          docker run --rm \
            -v "$PWD/policies:/policies:ro" \
            openpolicyagent/opa:1.10.0 \
            test -v /policies

      - name: Validate training gate entrypoint
        run: |
          printf '%s' '{"metadata":{"labels":["class:netplus"]},"limits":{"attacker_max_exploits":0},"network":{"egress":"deny"}}' \
          | docker run --rm -i \
              -v "$PWD/policies":/policies:ro \
              openpolicyagent/opa:1.10.0 \
              eval -b /policies --stdin-input 'data.foundry.training.allow' \
              >/dev/null

  build-services:
    name: Build (and optionally push) service images
    runs-on: ubuntu-latest
    needs: policy-check
    strategy:
      matrix:
        service: [orchestrator, spawn_service]

    env:
      REGISTRY: ghcr.io
      IMAGE_REPO: arescore-foundry

    steps:
      - uses: actions/checkout@v4

      - name: Compute lowercase owner
        id: lc
        shell: bash
        run: |
          owner="${{ github.repository_owner }}"
          owner_lc="$(echo "$owner" | tr '[:upper:]' '[:lower:]')"
          echo "owner=$owner_lc" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build service image (PR builds only, pushes on branch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/${{ matrix.service }}/Dockerfile
          push: ${{ github.event_name == 'push' }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.lc.outputs.owner }}/${{ env.IMAGE_REPO }}:${{ matrix.service }}-commit-${{ github.sha }}
            ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && format('{0}/{1}/{2}:{3}-latest', env.REGISTRY, steps.lc.outputs.owner, env.IMAGE_REPO, matrix.service) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  sbom-and-scan:
    name: SBOM & CVE scan
    runs-on: ubuntu-latest
    needs: policy-check
    strategy:
      matrix:
        service: [orchestrator, spawn_service, revocation_service, consent_registry, evidence_bundler, fl_coordinator]

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build service image for scanning
        run: |
          docker build \
            -t sbom/${{ matrix.service }}:ci \
            -f services/${{ matrix.service }}/Dockerfile \
            .

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: sbom/${{ matrix.service }}:ci
          format: spdx-json
          output-file: sbom-${{ matrix.service }}.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.service }}
          path: sbom-${{ matrix.service }}.spdx.json

      - name: CVE scan (Grype)
        uses: anchore/scan-action@v4
        with:
          image: sbom/${{ matrix.service }}:ci
          fail-build: true
          severity-cutoff: high
