services:
  orchestrator:
    build: ./orchestrator
    ports: ["8000:8000"]
    read_only: true
    tmpfs: ["/tmp"]
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import sys,urllib.request,socket; socket.setdefaulttimeout(2); urllib.request.urlopen('http://localhost:8000/health'); sys.exit(0)\" || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  frontend:
    build: ./frontend
    ports: ["3000:8080"]
    depends_on:
      orchestrator:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
      - /var/run
      - /var/cache/nginx
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/ready >/dev/null || wget -qO- http://localhost:8080/ready >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  log_indexer:
    build: ./log_indexer
    ports: ["8080:8080"]
    read_only: true
    tmpfs: ["/tmp"]
    security_opt: ["no-new-privileges:true"]
    cap_drop: [ALL]
    # real health is already patched into indexer.py
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import sys,urllib.request,socket; socket.setdefaulttimeout(2); urllib.request.urlopen('http://localhost:8080/health'); sys.exit(0)\" || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s
