x-common-env: &common-env
  LOG_ENDPOINT: http://log_indexer:8080/log
  LOG_TOKEN: ${LOG_TOKEN:-changeme-dev}
  REDACT_KEYS: ${REDACT_KEYS:-password,token,apikey,secret}
  JWT_ISSUER: ${JWT_ISSUER:-forge.local}
  JWT_AUD: ${JWT_AUD:-forge}
  SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-svc}

services:
  orchestrator:
    build:
      context: ../orchestrator
      dockerfile: Dockerfile
    environment:
      <<: *common-env
      SERVICE_NAME: orchestrator
    ports: ["8000:8000"]
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/ready"]
      interval: 20s
      timeout: 3s
      retries: 3
    depends_on: [log_indexer]

  log_indexer:
    build:
      context: ../log_indexer
      dockerfile: Dockerfile
    environment:
      LOG_TOKEN: ${LOG_TOKEN:-changeme-dev}
    ports: ["8080:8080"]
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 20s
      timeout: 3s
      retries: 3

  frontend:
    build:
      context: ../frontend
    # Dockerfile lives in frontend/
      dockerfile: Dockerfile
    environment:
      API_BASE: ${API_BASE:-http://localhost:8000}
    ports: ["3000:8080"]
    depends_on: [orchestrator]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/"]
      interval: 20s
      timeout: 3s
      retries: 3

networks:
  default: {}
